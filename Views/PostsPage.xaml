<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:models="clr-namespace:SocialSyncApp.Models"
             x:Class="SocialSyncApp.Views.PostsPage"
             Title="Posts"
             BackgroundColor="{AppThemeBinding Light=#FAFAFA, Dark=#0F0F0F}">

    <Grid RowDefinitions="Auto,*" Padding="0">

        <Grid Grid.Row="0" 
              BackgroundColor="{AppThemeBinding Light=#FFFFFF, Dark=#121212}"
              Padding="20,10"
              ColumnDefinitions="*,Auto"
              RowSpacing="0">

            <VerticalStackLayout Grid.Column="0">
                <Label Text="SocialSync Feed"
                       FontSize="28"
                       FontAttributes="Bold"
                       TextColor="{AppThemeBinding Light=#1A1A1A, Dark=#FFFFFF}"
                       VerticalOptions="Start"/>
                <Label Text="Latest updates from your network"
                       FontSize="14"
                       TextColor="{AppThemeBinding Light=#666666, Dark=#888888}"
                       VerticalOptions="Start"
                       Margin="0,-2,0,0"/>
            </VerticalStackLayout>

            <Button Grid.Column="1"
                    Text="Create"
                    BackgroundColor="{AppThemeBinding Light=#6366F1, Dark=#818CF8}"
                    TextColor="White"
                    CornerRadius="12"
                    Padding="24,14"
                    FontAttributes="Bold"
                    FontSize="14"
                    Clicked="OnNewPostClicked">
                <Button.Shadow>
                    <Shadow Brush="{AppThemeBinding Light=#6366F155, Dark=#818CF855}" Offset="0,4" Radius="8"/>
                </Button.Shadow>
            </Button>
        </Grid>

        <ActivityIndicator Grid.Row="1"
                           x:Name="LoadingSpinner"
                           IsRunning="True"
                           IsVisible="True"
                           HorizontalOptions="Center"
                           VerticalOptions="Center"
                           Color="#6366F1"/>

        <RefreshView Grid.Row="1" 
                     x:Name="FeedRefreshView"
                     Command="{Binding LoadPostsCommand}"
                     Refreshing="OnRefreshing"
                     IsVisible="False">

            <CollectionView x:Name="PostsCollectionView"
                            SelectionMode="None"
                            Margin="16">
                <CollectionView.ItemsLayout>
                    <LinearItemsLayout Orientation="Vertical" ItemSpacing="20"/>
                </CollectionView.ItemsLayout>

                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="models:Post">
                        <Frame Padding="0"
                               CornerRadius="20"
                               HasShadow="True"
                               BackgroundColor="{AppThemeBinding Light=#FFFFFF, Dark=#1A1A1A}"
                               BorderColor="{AppThemeBinding Light=#F0F0F0, Dark=#2A2A2A}">

                            <VerticalStackLayout Spacing="0">
                                <Grid Padding="20,16,16,16"
                                      ColumnDefinitions="48,*,Auto"
                                      ColumnSpacing="12">

                                    <Frame Grid.Column="0" 
                                           Padding="0" 
                                           CornerRadius="24" 
                                           WidthRequest="48" 
                                           HeightRequest="48"
                                           IsClippedToBounds="True">
                                        <Image Source="{Binding AvatarUrl}" Aspect="AspectFill"/>
                                    </Frame>

                                    <VerticalStackLayout Grid.Column="1"
                                                         VerticalOptions="Center"
                                                         Spacing="2">
                                        <Label Text="{Binding Author}"
                                               FontAttributes="Bold"
                                               FontSize="16"
                                               TextColor="{AppThemeBinding Light=#1A1A1A, Dark=#FFFFFF}"/>

                                        <HorizontalStackLayout Spacing="6">
                                            <Label Text="{Binding TimeAgo}"
                                                   FontSize="12"
                                                   TextColor="{AppThemeBinding Light=#666666, Dark=#888888}"/>
                                            <Label Text="â€¢"
                                                   FontSize="12"
                                                   TextColor="{AppThemeBinding Light=#666666, Dark=#888888}"/>
                                            <Label Text="{Binding Category}"
                                                   FontSize="12"
                                                   TextColor="#6366F1"
                                                   FontAttributes="Bold"/>
                                        </HorizontalStackLayout>
                                    </VerticalStackLayout>

                                    <HorizontalStackLayout Grid.Column="2" Spacing="0">

                                        <HorizontalStackLayout IsVisible="{Binding IsOwner}" Spacing="5">
                                            <Button Text="âœï¸"
                                                    BackgroundColor="#E0F7FA"
                                                    TextColor="#006064"
                                                    FontSize="16"
                                                    WidthRequest="40"
                                                    HeightRequest="40"
                                                    CornerRadius="20"
                                                    Padding="0"
                                                    Clicked="OnEditPostClicked"
                                                    CommandParameter="{Binding .}"/>

                                            <Button Text="ðŸ—‘ï¸"
                                                    BackgroundColor="#FFEBEE"
                                                    TextColor="#C62828"
                                                    FontSize="16"
                                                    WidthRequest="40"
                                                    HeightRequest="40"
                                                    CornerRadius="20"
                                                    Padding="0"
                                                    Clicked="OnDeletePostClicked"
                                                    CommandParameter="{Binding .}"/>
                                        </HorizontalStackLayout>

                                        <Button Text="â€¢â€¢â€¢"
                                                BackgroundColor="Transparent"
                                                TextColor="{AppThemeBinding Light=#666666, Dark=#888888}"
                                                FontSize="18"
                                                WidthRequest="40"
                                                HeightRequest="40"
                                                Clicked="OnPostOptionsClicked">
                                            <Button.Triggers>
                                                <DataTrigger TargetType="Button" Binding="{Binding IsOwner}" Value="True">
                                                    <Setter Property="IsVisible" Value="False" />
                                                </DataTrigger>
                                            </Button.Triggers>
                                        </Button>

                                    </HorizontalStackLayout>
                                </Grid>

                                <VerticalStackLayout Padding="20,0,20,16" Spacing="16">
                                    <Label Text="{Binding Title}" 
                                           FontAttributes="Bold"
                                           FontSize="16"
                                           IsVisible="{Binding Title, Converter={StaticResource StringIsNotNullOrEmptyConverter}}"/>

                                    <Label Text="{Binding Content}"
                                           FontSize="15"
                                           LineHeight="1.4"
                                           TextColor="{AppThemeBinding Light=#333333, Dark=#DDDDDD}"/>

                                    <Frame Padding="0"
                                           CornerRadius="16"
                                           HasShadow="False"
                                           HeightRequest="240"
                                           IsVisible="{Binding HasImage}"
                                           HorizontalOptions="FillAndExpand">
                                        <Image Source="{Binding ImageUrl}"
                                               Aspect="AspectFill"/>
                                    </Frame>
                                </VerticalStackLayout>

                                <Grid Padding="20,16,20,16"
                                      ColumnDefinitions="*,Auto"
                                      BackgroundColor="{AppThemeBinding Light=#FAFAFA, Dark=#252525}">

                                    <HorizontalStackLayout Grid.Column="0" Spacing="16">
                                        <Label Text="â¤ï¸ Like" FontSize="14" TextColor="#666"/>
                                        <Label Text="ðŸ’¬ Comment" FontSize="14" TextColor="#666"/>
                                    </HorizontalStackLayout>

                                    <Button Grid.Column="1"
                                            Text="Share"
                                            BackgroundColor="Transparent"
                                            TextColor="#6366F1"
                                            FontSize="13"
                                            FontAttributes="Bold"
                                            BorderColor="#6366F1"
                                            BorderWidth="1"
                                            CornerRadius="8"
                                            Padding="16,8"
                                            HeightRequest="36"/>
                                </Grid>
                            </VerticalStackLayout>
                        </Frame>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </RefreshView>

        <Label x:Name="EmptyStateLabel"
               Grid.Row="1"
               Text="No posts yet. Be the first! ðŸš€"
               FontSize="16"
               HorizontalOptions="Center"
               VerticalOptions="Center"
               TextColor="#999"
               IsVisible="False"/>

    </Grid>
</ContentPage>